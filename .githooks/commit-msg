#!/usr/bin/env bash
#
# commit-msg hook: validate and normalize Conventional Commits format.
#   type[(scope)]: description
#
# Allowed types: feat fix build chore ci docs style refactor perf test
# Merge, revert, fixup, and squash commits pass through without validation.

set -euo pipefail

MSG_FILE="$1"
MSG=$(cat "$MSG_FILE")

# Extract the subject line (first line).
SUBJECT=$(head -n 1 "$MSG_FILE")

# Allow merge commits.
if echo "$SUBJECT" | grep -qE '^Merge '; then
  exit 0
fi

# Allow revert commits.
if echo "$SUBJECT" | grep -qE '^Revert '; then
  exit 0
fi

# Allow fixup and squash commits (generated by git commit --fixup/--squash).
if echo "$SUBJECT" | grep -qE '^(fixup|squash)! '; then
  exit 0
fi

TYPES="feat|fix|build|chore|ci|docs|style|refactor|perf|test"

# Validate the subject against the Conventional Commits pattern.
if ! echo "$SUBJECT" | grep -qE "^($TYPES)(\([a-zA-Z0-9_-]+\))?!?: ."; then
  echo >&2 "ERROR: commit message does not follow Conventional Commits format."
  echo >&2 ""
  echo >&2 "  Expected: <type>[(<scope>)]: <description>"
  echo >&2 ""
  echo >&2 "  Allowed types: feat fix build chore ci docs style refactor perf test"
  echo >&2 ""
  echo >&2 "  Examples:"
  echo >&2 "    feat: add user login"
  echo >&2 "    fix(parser): handle empty input"
  echo >&2 "    docs: update README"
  echo >&2 ""
  echo >&2 "  Your message:"
  echo >&2 "    $SUBJECT"
  exit 1
fi

# --- Normalization ---

# Strip all trailing periods from the subject line.
NORMALIZED=$(echo "$SUBJECT" | sed 's/\.*$//')

# Lowercase the first letter of the description (the part after ": ").
NORMALIZED=$(echo "$NORMALIZED" | sed 's/\(: \)\(.\)/\1\L\2/')

# Reconstruct the full message if the subject changed.
if [ "$NORMALIZED" != "$SUBJECT" ]; then
  # Get the rest of the message (lines after the first).
  BODY=$(tail -n +2 "$MSG_FILE")
  if [ -n "$BODY" ]; then
    printf '%s\n%s\n' "$NORMALIZED" "$BODY" > "$MSG_FILE"
  else
    printf '%s\n' "$NORMALIZED" > "$MSG_FILE"
  fi
fi
